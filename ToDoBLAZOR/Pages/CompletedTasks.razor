@page "/CompletedTasks"
@using DataAccessLibrary
@using DataAccessLibrary.Models

@inject NavigationManager NavManager
@inject ISqlDataAccess _db

<h3>Completed Tasks</h3>

<button @onclick="OnDeleteAll" class="btn btn-danger">Delete All</button>
<table class="table table-striped container-fluid">
    <thead>
        <tr class="row text-center">
            <th class="col-sm-4">Description</th>
            <th class="col-sm-1">Priority</th>
            <th class="col-sm-1">Date Completed</th>
            <th class="col-sm-3">Subtasks</th>
            <th class="col-sm-2">Tags</th>
            <th class="col-sm-1">Buttons</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var t in tasks)
        {
            if (t.CompletionFlag)
            {
                <tr class="row">
                    <td class="col-sm-4">@t.Description</td>
                    <td class="col-sm-1">@t.Priority</td>
                    <td class="col-sm-1">@t.DateCompleted.ToString("yyyy/MM/dd")</td>
                    <td class="col-sm-3">
                        @if (t.Subtasks is null || t.Subtasks.Count == 0)
                        {
                            <ul>There are no subtasks</ul>
                        }
                        else
                        {
                            foreach (var s in t.Subtasks)
                            {
                                <ul>
                                    <li>
                                        @s.Description
                                    </li>

                                </ul>

                            }
                        }
                    </td>
                    <td class="col-sm-2">
                        @if (t.Tags is null || t.Tags.Count == 0)
                        {
                            <ul>There are no tags</ul>
                        }
                        else
                        {
                            foreach (var tag in t.Tags)
                            {
                                <ul>
                                    <li>@tag.Name</li>
                                </ul>
                            }
                        }
                    </td>
                    <td class="col-sm-1">
                        <div class="btn-group">
                            <button class="btn-danger" @onclick="e=> OnDelete(t.Id)"><i class="far fa-trash-alt"></i></button>
                            <button class="btn-secondary" @onclick="e=> ShowCopyTask(t)"><i class="fas fa-copy"></i></button>
                        </div>

                    </td>
                </tr>
            }
        }
    </tbody>
</table>
@code {
    [CascadingParameter] public IModalService Modal { get; set; }
    private List<TaskModel> tasks;

    private void OnDelete(int Id)
    {
        _db.DeleteTask(Id);
        tasks.RemoveAll(x => x.Id == Id);
    }

    private void OnDeleteAll()
    {
        _db.DeleteAllCompleted();
        tasks.Clear();
    }
    async Task ShowCopyTask(TaskModel model)
    {

        var parameters = new ModalParameters();
        parameters.Add(nameof(CopyTask.copyTask), model);

        var formModal = Modal.Show<CopyTask>("Copy Task", parameters);
        var result = await formModal.Result;
        if (!result.Cancelled)
        {
            NavManager.NavigateTo("/TodoList");
        }

    }

    protected override void OnInitialized()
    {
        tasks = _db.Tasks_GetAll();
    }
}
